{"version":3,"file":"send-app-uninstalled-webhook.js","sourceRoot":"","sources":["../../../../src/cli/services/webhook/send-app-uninstalled-webhook.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,kBAAkB,EAAC,MAAM,2BAA2B,CAAA;AAC5D,OAAO,EAAC,gBAAgB,EAAgB,MAAM,qBAAqB,CAAA;AACnE,OAAO,EAAC,mBAAmB,EAAC,MAAM,4BAA4B,CAAA;AAC9D,OAAO,EAAC,eAAe,EAAC,MAAM,oBAAoB,CAAA;AAClD,OAAO,EAAC,UAAU,EAAC,MAAM,4BAA4B,CAAA;AACrD,OAAO,EAAC,KAAK,EAAC,MAAM,8BAA8B,CAAA;AAWlD,MAAM,CAAC,KAAK,UAAU,+BAA+B,CACnD,OAA+C;IAE/C,MAAM,WAAW,GAAG,MAAM,kBAAkB,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;IAE3D,MAAM,MAAM,GAAG,MAAM,gBAAgB,CACnC,OAAO,CAAC,KAAK,EACb,iBAAiB;IACjB,iDAAiD;IACjD,WAAW,CAAC,CAAC,CAAE,EACf,eAAe,CAAC,SAAS,EACzB,OAAO,CAAC,OAAO,EACf,OAAO,CAAC,YAAY,CACrB,CAAA;IAED,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,+CAA+C,CAAC,CAAA;IAErE,MAAM,MAAM,GAAG,MAAM,cAAc,CAAC,OAAO,EAAE,MAAM,CAAC,CAAA;IAEpD,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,mCAAmC,CAAC,CAAC,CAAC,yCAAyC,CAAC,CAAA;IAE9G,OAAO,MAAM,CAAA;AACf,CAAC;AAED,KAAK,UAAU,cAAc,CAC3B,OAA+C,EAC/C,MAAqB;IAErB,IAAI,KAAK,GAAG,CAAC,CAAA;IAEb,qCAAqC;IACrC,OAAO,KAAK,GAAG,CAAC,EAAE;QAChB,IAAI;YACF,MAAM,MAAM,GAAG,MAAM,mBAAmB,CACtC,OAAO,CAAC,OAAO,EACf,MAAM,CAAC,aAAa,EACpB,IAAI,CAAC,SAAS,CAAC;gBACb,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC;gBAC7B,uBAAuB,EAAE,OAAO,CAAC,SAAS;aAC3C,CAAC,CACH,CAAA;YAED,OAAO,MAAM,CAAA;SACd;QAAC,OAAO,KAAK,EAAE;YACd,IAAI,KAAK,YAAY,UAAU,IAAI,KAAK,CAAC,IAAI,KAAK,cAAc,EAAE;gBAChE,IAAI,KAAK,GAAG,CAAC,EAAE;oBACb,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,iDAAiD,CAAC,CAAA;oBACvE,MAAM,KAAK,CAAC,CAAC,CAAC,CAAA;iBACf;aACF;iBAAM;gBACL,MAAM,KAAK,CAAA;aACZ;SACF;QAED,KAAK,EAAE,CAAA;KACR;IACD,oCAAoC;IAEpC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,uCAAuC,CAAC,CAAA;IAE7D,OAAO,KAAK,CAAA;AACd,CAAC","sourcesContent":["import {requestApiVersions} from './request-api-versions.js'\nimport {getWebhookSample, SampleWebhook} from './request-sample.js'\nimport {triggerLocalWebhook} from './trigger-local-webhook.js'\nimport {DELIVERY_METHOD} from './trigger-flags.js'\nimport {FetchError} from '@shopify/cli-kit/node/http'\nimport {sleep} from '@shopify/cli-kit/node/system'\nimport {Writable} from 'stream'\n\ninterface SendUninstallWebhookToAppServerOptions {\n  stdout: Writable\n  token: string\n  storeFqdn: string\n  address: string\n  sharedSecret: string\n}\n\nexport async function sendUninstallWebhookToAppServer(\n  options: SendUninstallWebhookToAppServerOptions,\n): Promise<boolean> {\n  const apiVersions = await requestApiVersions(options.token)\n\n  const sample = await getWebhookSample(\n    options.token,\n    'app/uninstalled',\n    // Use the latest stable version, skipping the RC\n    apiVersions[1]!,\n    DELIVERY_METHOD.LOCALHOST,\n    options.address,\n    options.sharedSecret,\n  )\n\n  options.stdout.write('Sending APP_UNINSTALLED webhook to app server')\n\n  const result = await triggerWebhook(options, sample)\n\n  options.stdout.write(result ? 'APP_UNINSTALLED webhook delivered' : 'APP_UNINSTALLED webhook delivery failed')\n\n  return result\n}\n\nasync function triggerWebhook(\n  options: SendUninstallWebhookToAppServerOptions,\n  sample: SampleWebhook,\n): Promise<boolean> {\n  let tries = 0\n\n  /* eslint-disable no-await-in-loop */\n  while (tries < 3) {\n    try {\n      const result = await triggerLocalWebhook(\n        options.address,\n        sample.samplePayload,\n        JSON.stringify({\n          ...JSON.parse(sample.headers),\n          'X-Shopify-Shop-Domain': options.storeFqdn,\n        }),\n      )\n\n      return result\n    } catch (error) {\n      if (error instanceof FetchError && error.code === 'ECONNREFUSED') {\n        if (tries < 3) {\n          options.stdout.write(\"App isn't responding yet, retrying in 5 seconds\")\n          await sleep(5)\n        }\n      } else {\n        throw error\n      }\n    }\n\n    tries++\n  }\n  /* eslint-enable no-await-in-loop */\n\n  options.stdout.write(\"App hasn't started in time, giving up\")\n\n  return false\n}\n"]}