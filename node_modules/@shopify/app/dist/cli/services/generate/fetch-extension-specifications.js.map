{"version":3,"file":"fetch-extension-specifications.js","sourceRoot":"","sources":["../../../../src/cli/services/generate/fetch-extension-specifications.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,uBAAuB,EAAE,6BAA6B,EAAC,MAAM,2CAA2C,CAAA;AAIhH,OAAO,EACL,4BAA4B,GAG7B,MAAM,+CAA+C,CAAA;AAEtD,OAAO,EAAC,0BAA0B,EAAC,MAAM,+BAA+B,CAAA;AAExE,OAAO,EAAC,eAAe,EAAC,MAAM,oCAAoC,CAAA;AASlE;;;;;;;;;;;GAWG;AACH,MAAM,CAAC,KAAK,UAAU,mBAAmB,CAAC,EACxC,KAAK,EACL,MAAM,EACN,MAAM,GACqB;IAC3B,MAAM,MAAM,GAAuC,MAAM,eAAe,CAAC,4BAA4B,EAAE,KAAK,EAAE;QAC5G,OAAO,EAAE,MAAM;KAChB,CAAC,CAAA;IAEF,MAAM,uBAAuB,GAAmC,MAAM,CAAC,uBAAuB;SAC3F,MAAM,CAAC,CAAC,aAAa,EAAE,EAAE,CAAC,aAAa,CAAC,OAAO,CAAC,oBAAoB,KAAK,KAAK,CAAC;SAC/E,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE;QACZ,MAAM,OAAO,GAAG,IAAoC,CAAA;QACpD,gGAAgG;QAChG,gGAAgG;QAChG,IAAI,IAAI,CAAC,UAAU,KAAK,qBAAqB;YAAE,IAAI,CAAC,UAAU,GAAG,OAAO,CAAA;QACxE,IAAI,IAAI,CAAC,UAAU,KAAK,yBAAyB;YAAE,IAAI,CAAC,UAAU,GAAG,sBAAsB,CAAA;QAC3F,OAAO,CAAC,iBAAiB,GAAG,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAA;QAC1D,OAAO,CAAC,OAAO,GAAG,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,OAAO,CAAA;QAE9C,wFAAwF;QACxF,IAAI,IAAI,CAAC,UAAU,KAAK,wBAAwB;YAAE,OAAO,CAAC,OAAO,GAAG,eAAe,CAAA;QAEnF,OAAO,OAAO,CAAA;IAChB,CAAC,CAAC,CAAA;IAEJ,MAAM,EAAE,GAAG,MAAM,6BAA6B,CAAC,MAAM,CAAC,CAAA;IACtD,MAAM,KAAK,GAAG,MAAM,uBAAuB,EAAE,CAAA;IAC7C,MAAM,KAAK,GAAG,CAAC,GAAG,EAAE,EAAE,GAAG,KAAK,CAAC,CAAA;IAE/B,MAAM,YAAY,GAAG,wBAAwB,CAAC,KAAK,EAAE,uBAAuB,CAAC,CAAA;IAC7E,OAAO,CAAC,GAAG,YAAY,CAAC,CAAA;AAC1B,CAAC;AAED,SAAS,wBAAwB,CAC/B,KAAsB,EACtB,MAAsC;IAEtC,MAAM,OAAO,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE;QACjC,MAAM,UAAU,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,UAAU,KAAK,IAAI,CAAC,UAAU,CAAC,CAAA;QACjF,IAAI,UAAU;YAAE,OAAO,EAAC,GAAG,IAAI,EAAE,GAAG,UAAU,EAAC,CAAA;QAC/C,OAAO,SAAS,CAAA;IAClB,CAAC,CAAC,CAAA;IAEF,OAAO,0BAA0B,CAAuB,OAAO,CAAC,CAAA;AAClE,CAAC","sourcesContent":["import {loadThemeSpecifications, loadUIExtensionSpecifications} from '../../models/extensions/specifications.js'\nimport {UIExtensionSpec} from '../../models/extensions/ui.js'\nimport {ThemeExtensionSpec} from '../../models/extensions/theme.js'\nimport {GenericSpecification} from '../../models/app/extensions.js'\nimport {\n  ExtensionSpecificationsQuery,\n  ExtensionSpecificationsQuerySchema,\n  FlattenedRemoteSpecification,\n} from '../../api/graphql/extension_specifications.js'\n\nimport {getArrayRejectingUndefined} from '@shopify/cli-kit/common/array'\nimport {Config} from '@oclif/core'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\n\ntype ExtensionSpec = UIExtensionSpec | ThemeExtensionSpec\n\nexport interface FetchSpecificationsOptions {\n  token: string\n  apiKey: string\n  config: Config\n}\n/**\n * Returns all extension specifications the user has access to.\n * This includes:\n * - UI extensions\n * - Theme extensions\n *\n * Will return a merge of the local and remote specifications (remote values override local ones)\n * Will only return the specifications that are also defined locally\n *\n * @param token - Token to access partners API\n * @returns List of extension specifications\n */\nexport async function fetchSpecifications({\n  token,\n  apiKey,\n  config,\n}: FetchSpecificationsOptions): Promise<GenericSpecification[]> {\n  const result: ExtensionSpecificationsQuerySchema = await partnersRequest(ExtensionSpecificationsQuery, token, {\n    api_key: apiKey,\n  })\n\n  const extensionSpecifications: FlattenedRemoteSpecification[] = result.extensionSpecifications\n    .filter((specification) => specification.options.managementExperience === 'cli')\n    .map((spec) => {\n      const newSpec = spec as FlattenedRemoteSpecification\n      // WORKAROUND: The identifiers in the API are different for these extensions to the ones the CLI\n      // has been using so far. This is a workaround to keep the CLI working until the API is updated.\n      if (spec.identifier === 'theme_app_extension') spec.identifier = 'theme'\n      if (spec.identifier === 'subscription_management') spec.identifier = 'product_subscription'\n      newSpec.registrationLimit = spec.options.registrationLimit\n      newSpec.surface = spec.features?.argo?.surface\n\n      // Hardcoded value for the post purchase extension because the value is wrong in the API\n      if (spec.identifier === 'checkout_post_purchase') newSpec.surface = 'post_purchase'\n\n      return newSpec\n    })\n\n  const ui = await loadUIExtensionSpecifications(config)\n  const theme = await loadThemeSpecifications()\n  const local = [...ui, ...theme]\n\n  const updatedSpecs = mergeLocalAndRemoteSpecs(local, extensionSpecifications)\n  return [...updatedSpecs]\n}\n\nfunction mergeLocalAndRemoteSpecs(\n  local: ExtensionSpec[],\n  remote: FlattenedRemoteSpecification[],\n): GenericSpecification[] {\n  const updated = local.map((spec) => {\n    const remoteSpec = remote.find((remote) => remote.identifier === spec.identifier)\n    if (remoteSpec) return {...spec, ...remoteSpec}\n    return undefined\n  })\n\n  return getArrayRejectingUndefined<GenericSpecification>(updated)\n}\n"]}