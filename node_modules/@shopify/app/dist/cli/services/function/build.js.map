{"version":3,"file":"build.js","sourceRoot":"","sources":["../../../../src/cli/services/function/build.ts"],"names":[],"mappings":"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","sourcesContent":["import {FunctionExtension} from '../../models/app/extensions.js'\nimport {exec} from '@shopify/cli-kit/node/system'\nimport {joinPath} from '@shopify/cli-kit/node/path'\nimport {build as esBuild} from 'esbuild'\nimport {findPathUp} from '@shopify/cli-kit/node/fs'\nimport {AbortSignal} from '@shopify/cli-kit/node/abort'\nimport {renderTasks} from '@shopify/cli-kit/node/ui'\nimport {Writable} from 'stream'\n\ninterface JSFunctionBuildOptions {\n  stdout: Writable\n  stderr: Writable\n  signal?: AbortSignal\n  // we want to use tasks when this is a primary command, i.e. 'shopify app function build',\n  // but we don't want the fancy UI when this is running as part of 'shopify app build'.\n  useTasks?: boolean\n}\n\nexport async function buildJSFunction(fun: FunctionExtension, options: JSFunctionBuildOptions) {\n  if (options.useTasks) {\n    return buildJSFunctionWithTasks(fun, options)\n  } else {\n    return buildJSFunctionWithoutTasks(fun, options)\n  }\n}\n\nasync function buildJSFunctionWithoutTasks(fun: FunctionExtension, options: JSFunctionBuildOptions) {\n  options.stdout.write(`Building GraphQL types...\\n`)\n  await buildGraphqlTypes(fun, options)\n  options.stdout.write(`Bundling JS function...\\n`)\n  await bundleExtension(fun, options)\n  options.stdout.write(`Running javy...\\n`)\n  await runJavy(fun, options)\n  options.stdout.write(`Done!\\n`)\n}\n\nexport async function buildJSFunctionWithTasks(fun: FunctionExtension, options: JSFunctionBuildOptions) {\n  await renderTasks([\n    {\n      title: 'Building GraphQL types',\n      task: async () => {\n        await buildGraphqlTypes(fun, options)\n      },\n    },\n    {\n      title: 'Bundling JS function',\n      task: async () => {\n        await bundleExtension(fun, options)\n      },\n    },\n    {\n      title: 'Running javy',\n      task: async () => {\n        await runJavy(fun, options)\n      },\n    },\n  ])\n}\n\nexport async function buildGraphqlTypes(\n  fun: {directory: string; isJavaScript: boolean},\n  options: JSFunctionBuildOptions,\n) {\n  if (!fun.isJavaScript) {\n    throw new Error('GraphQL types can only be built for JavaScript functions')\n  }\n\n  return exec('npm', ['exec', '--', 'graphql-code-generator', '--config', 'package.json'], {\n    cwd: fun.directory,\n    stderr: options.stderr,\n    signal: options.signal,\n  })\n}\n\nexport async function bundleExtension(fun: FunctionExtension, options: JSFunctionBuildOptions) {\n  const entryPoint = await findPathUp('node_modules/@shopify/shopify_function/index.ts', {\n    type: 'file',\n    cwd: fun.directory,\n  })\n  if (!entryPoint) {\n    throw new Error(\n      \"Could not find the Shopify Function runtime. Make sure you have '@shopify/shopify_function' installed\",\n    )\n  }\n  if (!fun.entrySourceFilePath) {\n    throw new Error('Could not find your function entry point. It must be in src/index.js or src/index.ts')\n  }\n\n  const esbuildOptions = getESBuildOptions(fun.directory, entryPoint, fun.entrySourceFilePath)\n  return esBuild(esbuildOptions)\n}\n\nfunction getESBuildOptions(directory: string, entryPoint: string, userFunction: string): Parameters<typeof esBuild>[0] {\n  const esbuildOptions: Parameters<typeof esBuild>[0] = {\n    outfile: joinPath(directory, 'dist/function.js'),\n    entryPoints: [entryPoint],\n    alias: {\n      'user-function': userFunction,\n    },\n    logLevel: 'silent',\n    bundle: true,\n    legalComments: 'none',\n    target: 'es2022',\n    format: 'esm',\n  }\n  return esbuildOptions\n}\n\nexport async function runJavy(fun: FunctionExtension, options: JSFunctionBuildOptions) {\n  return exec('npm', ['exec', '--', 'javy', 'compile', '-d', '-o', fun.buildWasmPath, 'dist/function.js'], {\n    cwd: fun.directory,\n    stdout: options.stdout,\n    stderr: options.stderr,\n    signal: options.signal,\n  })\n}\n\ninterface FunctionRunnerOptions {\n  json: boolean\n}\n\nexport async function runFunctionRunner(fun: FunctionExtension, options: FunctionRunnerOptions) {\n  const outputAsJson = options.json ? ['--json'] : []\n  return exec('npm', ['exec', '--', 'function-runner', '-f', fun.buildWasmPath, ...outputAsJson], {\n    cwd: fun.directory,\n    stdin: 'inherit',\n    stdout: 'inherit',\n    stderr: 'inherit',\n  })\n}\n"]}