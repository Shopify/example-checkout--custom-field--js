{"version":3,"file":"store.js","sourceRoot":"","sources":["../../../../../../src/cli/services/dev/extension/payload/store.ts"],"names":[],"mappings":"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","sourcesContent":["import {UIExtensionPayload, ExtensionsEndpointPayload, DevNewExtensionPointSchema} from './models.js'\nimport {ExtensionDevOptions} from '../../extension.js'\nimport {getUIExtensionPayload, isNewExtensionPointsSchema} from '../payload.js'\nimport {UIExtension} from '../../../../models/app/extensions.js'\nimport {buildAppURLForMobile, buildAppURLForWeb} from '../../../../utilities/app/app-url.js'\nimport {deepMergeObjects} from '@shopify/cli-kit/common/object'\nimport {outputDebug, outputContent} from '@shopify/cli-kit/node/output'\nimport {EventEmitter} from 'events'\n\nexport interface ExtensionsPayloadStoreOptions extends ExtensionDevOptions {\n  websocketURL: string\n}\n\nexport enum ExtensionsPayloadStoreEvent {\n  Update = 'PayloadUpdatedEvent:UPDATE',\n}\n\nexport async function getExtensionsPayloadStoreRawPayload(\n  options: ExtensionsPayloadStoreOptions,\n): Promise<ExtensionsEndpointPayload> {\n  return {\n    app: {\n      title: options.app.name,\n      apiKey: options.apiKey,\n      url: buildAppURLForWeb(options.storeFqdn, options.url),\n      mobileUrl: buildAppURLForMobile(options.storeFqdn, options.apiKey),\n    },\n    appId: options.id,\n    version: '3',\n    root: {\n      url: new URL('/extensions', options.url).toString(),\n    },\n    socket: {\n      url: options.websocketURL,\n    },\n    devConsole: {\n      url: new URL('/extensions/dev-console', options.url).toString(),\n    },\n    store: options.storeFqdn,\n    extensions: await Promise.all(options.extensions.map((extension) => getUIExtensionPayload(extension, options))),\n  }\n}\n\nexport class ExtensionsPayloadStore extends EventEmitter {\n  private options: ExtensionsPayloadStoreOptions\n  private rawPayload: ExtensionsEndpointPayload\n\n  constructor(rawPayload: ExtensionsEndpointPayload, options: ExtensionsPayloadStoreOptions) {\n    super()\n    this.rawPayload = rawPayload\n    this.options = options\n  }\n\n  getConnectedPayload() {\n    const rawPayload = this.getRawPayload()\n    return {\n      app: rawPayload.app,\n      appId: rawPayload.appId,\n      store: rawPayload.store,\n      extensions: rawPayload.extensions,\n    }\n  }\n\n  getRawPayloadFilteredByExtensionIds(extensionIds: string[]) {\n    return {\n      ...this.rawPayload,\n      extensions: this.rawPayload.extensions.filter((extension) => extensionIds.includes(extension.uuid)),\n    }\n  }\n\n  getRawPayload() {\n    return this.rawPayload\n  }\n\n  updateApp(app: Partial<ExtensionsEndpointPayload> & {[key: string]: unknown}) {\n    this.rawPayload = deepMergeObjects(this.rawPayload, {\n      app,\n    })\n    this.emitUpdate([])\n  }\n\n  updateExtensions(extensions: UIExtensionPayload[]) {\n    const updatedExtensionsPayload = this.rawPayload.extensions.map((rawPayloadExtension) => {\n      const foundExtension = extensions.find((ext) => ext.uuid === rawPayloadExtension.uuid)\n\n      if (foundExtension) {\n        // We can't do a simple union or replacement when it comes to extension points array\n        // We need special logic to merge extension points only when the target matches\n        if (\n          isNewExtensionPointsSchema(foundExtension.extensionPoints) &&\n          isNewExtensionPointsSchema(rawPayloadExtension.extensionPoints)\n        ) {\n          const foundExtensionPointsPayloadMap = foundExtension.extensionPoints.reduce((acc, ex) => {\n            return {...acc, [ex.target]: ex}\n          }, {} as {[key: string]: DevNewExtensionPointSchema})\n\n          rawPayloadExtension.extensionPoints = deepMergeObjects(\n            rawPayloadExtension.extensionPoints,\n            foundExtension.extensionPoints,\n            (destinationArray) => {\n              return (destinationArray as DevNewExtensionPointSchema[]).map((extensionPoint) => {\n                const extensionPointPayload = foundExtensionPointsPayloadMap[extensionPoint.target]\n                if (extensionPointPayload) {\n                  return deepMergeObjects(extensionPoint, extensionPointPayload)\n                }\n                return extensionPoint\n              })\n            },\n          )\n\n          const {extensionPoints, ...rest} = foundExtension\n          return deepMergeObjects(rawPayloadExtension, rest)\n        }\n\n        return deepMergeObjects(rawPayloadExtension, foundExtension)\n      }\n\n      return rawPayloadExtension\n    })\n\n    this.rawPayload = {\n      ...this.rawPayload,\n      extensions: updatedExtensionsPayload,\n    }\n\n    this.emitUpdate(extensions.map((extension) => extension.uuid))\n  }\n\n  async updateExtension(\n    extension: UIExtension,\n    options: ExtensionDevOptions,\n    development?: Partial<UIExtensionPayload['development']>,\n  ) {\n    const payloadExtensions = this.rawPayload.extensions\n    const index = payloadExtensions.findIndex((extensionPayload) => extensionPayload.uuid === extension.devUUID)\n\n    if (index === -1) {\n      outputDebug(\n        outputContent`Could not updateExtension() for extension with uuid: ${extension.devUUID}`,\n        options.stderr,\n      )\n      return\n    }\n\n    payloadExtensions[index] = await getUIExtensionPayload(extension, {\n      ...this.options,\n      currentDevelopmentPayload: development || {status: payloadExtensions[index]?.development.status},\n      currentLocalizationPayload: payloadExtensions[index]?.localization,\n    })\n\n    this.rawPayload.extensions = payloadExtensions\n\n    this.emitUpdate([extension.devUUID])\n  }\n\n  private emitUpdate(extensionIds: string[]) {\n    this.emit(ExtensionsPayloadStoreEvent.Update, extensionIds)\n  }\n}\n"]}