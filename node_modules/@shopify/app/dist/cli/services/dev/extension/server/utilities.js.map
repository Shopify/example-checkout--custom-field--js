{"version":3,"file":"utilities.js","sourceRoot":"","sources":["../../../../../../src/cli/services/dev/extension/server/utilities.ts"],"names":[],"mappings":"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","sourcesContent":["import {UIExtension} from '../../../../models/app/extensions.js'\nimport {getUIExtensionResourceURL} from '../../../../utilities/extensions/configuration.js'\nimport {ExtensionDevOptions} from '../../extension.js'\nimport {getExtensionPointTargetSurface} from '../utilities.js'\nimport {createError, H3Error, ServerResponse, sendError as h3SendError} from 'h3'\n\nexport function getRedirectUrl(extension: UIExtension, options: ExtensionDevOptions): string {\n  const {url: resourceUrl} = getUIExtensionResourceURL(extension.configuration.type, options)\n\n  if (extension.surface === 'checkout' && resourceUrl) {\n    const rawUrl = new URL(`https://${options.storeFqdn}/`)\n    rawUrl.pathname = resourceUrl\n    rawUrl.searchParams.append('dev', `${options.url}/extensions`)\n\n    return rawUrl.toString()\n  } else if (extension.surface === 'customer_accounts') {\n    const [storeName, ...storeDomainParts] = options.storeFqdn.split('.')\n    const accountsUrl = `${storeName}.account.${storeDomainParts.join('.')}`\n    const origin = `${options.url}/extensions`\n\n    const rawUrl = new URL(`https://${accountsUrl}/extensions-development`)\n    rawUrl.searchParams.append('origin', origin)\n    rawUrl.searchParams.append('extensionId', extension.devUUID)\n\n    return rawUrl.toString()\n  } else {\n    const rawUrl = new URL(`https://${options.storeFqdn}/`)\n    rawUrl.pathname = 'admin/extensions-dev'\n    rawUrl.searchParams.append('url', getExtensionUrl(extension, options))\n\n    return rawUrl.toString()\n  }\n}\n\nexport function getExtensionPointRedirectUrl(\n  requestedTarget: string,\n  extension: UIExtension,\n  options: ExtensionDevOptions,\n): string | undefined {\n  const surface = getExtensionPointTargetSurface(requestedTarget)\n  const rawUrl = new URL(`https://${options.storeFqdn}/`)\n\n  switch (surface) {\n    case 'checkout':\n      // This can never be null because we always generate it\n      // whenever there is an extension point targeting Checkout\n      rawUrl.pathname = options.checkoutCartUrl!\n      rawUrl.searchParams.append('dev', `${options.url}/extensions`)\n      break\n    case 'admin':\n      rawUrl.pathname = 'admin/extensions-dev'\n      rawUrl.searchParams.append('url', getExtensionUrl(extension, options))\n      rawUrl.searchParams.append('target', requestedTarget)\n      break\n    default:\n      return undefined\n  }\n\n  return rawUrl.toString()\n}\n\nexport function getExtensionUrl(extension: UIExtension, options: ExtensionDevOptions): string {\n  const extensionUrl = new URL(options.url)\n  extensionUrl.pathname = `/extensions/${extension.devUUID}`\n  return extensionUrl.toString()\n}\n\nexport function sendError(response: ServerResponse, error: Partial<H3Error>) {\n  h3SendError(response.event, createError(error))\n}\n"]}