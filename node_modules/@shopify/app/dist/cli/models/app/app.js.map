{"version":3,"file":"app.js","sourceRoot":"","sources":["../../../../src/cli/models/app/app.ts"],"names":[],"mappings":"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","sourcesContent":["import {Extension, FunctionExtension, ThemeExtension, UIExtension} from './extensions.js'\nimport {AppErrors} from './loader.js'\nimport {zod} from '@shopify/cli-kit/node/schema'\nimport {DotEnvFile} from '@shopify/cli-kit/node/dot-env'\nimport {getDependencies, PackageManager, readAndParsePackageJson} from '@shopify/cli-kit/node/node-package-manager'\nimport {fileRealPath, findPathUp} from '@shopify/cli-kit/node/fs'\nimport {joinPath, dirname} from '@shopify/cli-kit/node/path'\n\nexport const AppConfigurationSchema = zod.object({\n  scopes: zod.string().default(''),\n  extensionDirectories: zod.array(zod.string()).optional(),\n  webDirectories: zod.array(zod.string()).optional(),\n})\n\nexport enum WebType {\n  Frontend = 'frontend',\n  Backend = 'backend',\n}\n\nconst ensurePathStartsWithSlash = (arg: unknown) => (typeof arg === 'string' && !arg.startsWith('/') ? `/${arg}` : arg)\n\nconst WebConfigurationAuthCallbackPathSchema = zod.preprocess(ensurePathStartsWithSlash, zod.string())\n\nexport const WebConfigurationSchema = zod.object({\n  type: zod.enum([WebType.Frontend, WebType.Backend]),\n  authCallbackPath: zod\n    .union([WebConfigurationAuthCallbackPathSchema, WebConfigurationAuthCallbackPathSchema.array()])\n    .optional(),\n  webhooksPath: zod.preprocess(ensurePathStartsWithSlash, zod.string()).optional(),\n  port: zod.number().max(65536).min(0).optional(),\n  commands: zod.object({\n    build: zod.string().optional(),\n    dev: zod.string(),\n  }),\n})\n\nexport type AppConfiguration = zod.infer<typeof AppConfigurationSchema>\nexport type WebConfiguration = zod.infer<typeof WebConfigurationSchema>\nexport type WebConfigurationCommands = keyof WebConfiguration['commands']\n\nexport interface Web {\n  directory: string\n  configuration: WebConfiguration\n  framework?: string\n}\n\nexport interface AppInterface {\n  name: string\n  idEnvironmentVariableName: string\n  directory: string\n  packageManager: PackageManager\n  configuration: AppConfiguration\n  configurationPath: string\n  nodeDependencies: {[key: string]: string}\n  webs: Web[]\n  usesWorkspaces: boolean\n  dotenv?: DotEnvFile\n  extensions: {\n    ui: UIExtension[]\n    theme: ThemeExtension[]\n    function: FunctionExtension[]\n  }\n  errors?: AppErrors\n  hasExtensions: () => boolean\n  hasUIExtensions: () => boolean\n  updateDependencies: () => Promise<void>\n  extensionsForType: (spec: {identifier: string; externalIdentifier: string}) => Extension[]\n}\n\nexport class App implements AppInterface {\n  name: string\n  idEnvironmentVariableName: string\n  directory: string\n  packageManager: PackageManager\n  configuration: AppConfiguration\n  configurationPath: string\n  nodeDependencies: {[key: string]: string}\n  webs: Web[]\n  usesWorkspaces: boolean\n  dotenv?: DotEnvFile\n  errors?: AppErrors\n  extensions: {\n    ui: UIExtension[]\n    theme: ThemeExtension[]\n    function: FunctionExtension[]\n  }\n\n  // eslint-disable-next-line max-params\n  constructor(\n    name: string,\n    idEnvironmentVariableName: string,\n    directory: string,\n    packageManager: PackageManager,\n    configuration: AppConfiguration,\n    configurationPath: string,\n    nodeDependencies: {[key: string]: string},\n    webs: Web[],\n    ui: UIExtension[],\n    theme: ThemeExtension[],\n    functions: FunctionExtension[],\n    usesWorkspaces: boolean,\n    dotenv?: DotEnvFile,\n    errors?: AppErrors,\n  ) {\n    this.name = name\n    this.idEnvironmentVariableName = idEnvironmentVariableName\n    this.directory = directory\n    this.packageManager = packageManager\n    this.configuration = configuration\n    this.configurationPath = configurationPath\n    this.nodeDependencies = nodeDependencies\n    this.webs = webs\n    this.dotenv = dotenv\n    this.extensions = {\n      ui,\n      theme,\n      function: functions,\n    }\n    this.errors = errors\n    this.usesWorkspaces = usesWorkspaces\n  }\n\n  async updateDependencies() {\n    const nodeDependencies = await getDependencies(joinPath(this.directory, 'package.json'))\n    this.nodeDependencies = nodeDependencies\n  }\n\n  hasExtensions(): boolean {\n    return (\n      this.extensions.ui.length !== 0 || this.extensions.function.length !== 0 || this.extensions.theme.length !== 0\n    )\n  }\n\n  hasUIExtensions(): boolean {\n    return this.extensions.ui.length > 0\n  }\n\n  extensionsForType(specification: {identifier: string; externalIdentifier: string}): Extension[] {\n    const allExternsions = [...this.extensions.ui, ...this.extensions.function, ...this.extensions.theme]\n    return allExternsions.filter(\n      (extension) => extension.type === specification.identifier || extension.type === specification.externalIdentifier,\n    )\n  }\n}\n\ntype RendererVersionResult = {name: string; version: string} | undefined | 'not_found'\n\n/**\n * Given a UI extension and the app it belongs to, it returns the version of the renderer package.\n * Looks for `/node_modules/@shopify/{renderer-package-name}/package.json` to find the real version used.\n * @param uiExtensionType - UI extension whose renderer version will be obtained.\n * @param app - App object containing the extension.\n * @returns The version if the dependency exists.\n */\nexport async function getUIExtensionRendererVersion(\n  extension: UIExtension,\n  app: AppInterface,\n): Promise<RendererVersionResult> {\n  // Look for the vanilla JS version of the dependency (the react one depends on it, will always be present)\n  const rendererDependency = extension.dependency\n  if (!rendererDependency) return undefined\n  return getDependencyVersion(rendererDependency.name, app.directory)\n}\n\nexport async function getDependencyVersion(dependency: string, directory: string): Promise<RendererVersionResult> {\n  const isReact = dependency.includes('-react')\n  let cwd = directory\n  /**\n   * PNPM creates a symlink to a global cache where dependencies are hoisted. Therefore\n   * we need to first look up the *-react package and use that as a working directory from\n   * where to look up the non-react package.\n   */\n  if (isReact) {\n    const dependencyName = dependency.split('/')\n    const pattern = joinPath('node_modules', dependencyName[0]!, dependencyName[1]!, 'package.json')\n    const reactPackageJsonPath = await findPathUp(pattern, {\n      type: 'file',\n      cwd: directory,\n      allowSymlinks: true,\n    })\n    if (!reactPackageJsonPath) {\n      return 'not_found'\n    }\n    cwd = await fileRealPath(dirname(reactPackageJsonPath))\n  }\n\n  // Split the dependency name to avoid using \"/\" in windows\n  const dependencyName = dependency.replace('-react', '').split('/')\n  const pattern = joinPath('node_modules', dependencyName[0]!, dependencyName[1]!, 'package.json')\n\n  let packagePath = await findPathUp(pattern, {\n    cwd,\n    type: 'file',\n    allowSymlinks: true,\n  })\n  if (!packagePath) return 'not_found'\n  packagePath = await fileRealPath(packagePath)\n\n  // Load the package.json and extract the version\n  const packageContent = await readAndParsePackageJson(packagePath)\n  if (!packageContent.version) return 'not_found'\n  return {name: dependency, version: packageContent.version}\n}\n"]}