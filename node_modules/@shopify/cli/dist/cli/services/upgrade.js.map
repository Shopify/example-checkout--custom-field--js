{"version":3,"file":"upgrade.js","sourceRoot":"","sources":["../../../src/cli/services/upgrade.ts"],"names":[],"mappings":"AAAA,OAAO,EACL,kBAAkB,EAClB,wBAAwB,EACxB,kBAAkB,EAElB,iBAAiB,GAElB,MAAM,4CAA4C,CAAA;AACnD,OAAO,EAAC,IAAI,EAAC,MAAM,8BAA8B,CAAA;AACjD,OAAO,EAAC,OAAO,EAAE,eAAe,EAAC,MAAM,4BAA4B,CAAA;AACnE,OAAO,EAAC,UAAU,EAAC,MAAM,0BAA0B,CAAA;AACnD,OAAO,EAAC,UAAU,EAAC,MAAM,6BAA6B,CAAA;AACtD,OAAO,EAAC,aAAa,EAAE,UAAU,EAAE,aAAa,EAAE,WAAW,EAAE,UAAU,EAAC,MAAM,8BAA8B,CAAA;AAI9G,oEAAoE;AACpE,MAAM,aAAa,GAAG,CAAC,gBAAgB,CAAC,CAAA;AAExC,MAAM,CAAC,KAAK,UAAU,OAAO,CAAC,SAAiB,EAAE,cAAsB;IACrE,IAAI,aAA4B,CAAA;IAEhC,MAAM,UAAU,GAAG,MAAM,aAAa,CAAC,SAAS,CAAC,CAAA;IACjD,IAAI,UAAU,EAAE;QACd,aAAa,GAAG,MAAM,mBAAmB,CAAC,UAAU,EAAE,cAAc,CAAC,CAAA;KACtE;SAAM,IAAI,mBAAmB,EAAE,EAAE;QAChC,MAAM,IAAI,UAAU,CAClB,aAAa,CAAA,4CAA4C,WAAW,CAAC,IAAI,CACvE,SAAS,CACV,2CAA2C,CAC7C,CAAA;KACF;SAAM;QACL,aAAa,GAAG,MAAM,oBAAoB,CAAC,cAAc,CAAC,CAAA;KAC3D;IAED,IAAI,aAAa,EAAE;QACjB,aAAa,CAAC,mCAAmC,aAAa,EAAE,CAAC,CAAA;KAClE;AACH,CAAC;AAED,KAAK,UAAU,aAAa,CAAC,SAAiB;IAC5C,MAAM,UAAU,GAAG,MAAM,UAAU,CAAC,CAAC,kBAAkB,EAAE,oBAAoB,EAAE,oBAAoB,CAAC,EAAE;QACpG,GAAG,EAAE,SAAS;QACd,IAAI,EAAE,MAAM;KACb,CAAC,CAAA;IACF,IAAI,UAAU;QAAE,OAAO,OAAO,CAAC,UAAU,CAAC,CAAA;AAC5C,CAAC;AAED,KAAK,UAAU,mBAAmB,CAAC,UAAkB,EAAE,cAAsB;IAC3E,MAAM,WAAW,GAAG,CAAC,MAAM,wBAAwB,CAAC,UAAU,CAAC,CAAC,CAAC,OAAO,CAAA;IACxE,MAAM,uBAAuB,GAAG,WAAW,CAAC,YAAY,IAAI,EAAE,CAAA;IAC9D,MAAM,0BAA0B,GAAG,WAAW,CAAC,eAAe,IAAI,EAAE,CAAA;IAEpE,IAAI,eAAe,GAAW,EAAC,GAAG,uBAAuB,EAAE,GAAG,0BAA0B,EAAC,CAAC,MAAM,aAAa,EAAE,CAAE,CAAA;IACjH,IAAI,eAAe,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC;QAAE,eAAe,GAAG,cAAc,CAAA;IAChF,MAAM,aAAa,GAAG,MAAM,kBAAkB,CAAC,MAAM,aAAa,EAAE,EAAE,eAAe,CAAC,CAAA;IAEtF,IAAI,CAAC,aAAa,EAAE;QAClB,wBAAwB,CAAC,eAAe,CAAC,CAAA;QACzC,OAAM;KACP;IAED,oBAAoB,CAAC,eAAe,EAAE,aAAa,CAAC,CAAA;IAEpD,MAAM,uBAAuB,CAAC,MAAM,EAAE,uBAAuB,EAAE,UAAU,CAAC,CAAA;IAC1E,MAAM,uBAAuB,CAAC,KAAK,EAAE,0BAA0B,EAAE,UAAU,CAAC,CAAA;IAC5E,OAAO,aAAa,CAAA;AACtB,CAAC;AAED,KAAK,UAAU,oBAAoB,CAAC,cAAsB;IACxD,MAAM,aAAa,GAAG,MAAM,kBAAkB,CAAC,MAAM,aAAa,EAAE,EAAE,cAAc,CAAC,CAAA;IAErF,IAAI,CAAC,aAAa,EAAE;QAClB,wBAAwB,CAAC,cAAc,CAAC,CAAA;QACxC,OAAM;KACP;IAED,oBAAoB,CAAC,cAAc,EAAE,aAAa,CAAC,CAAA;IAEnD,MAAM,eAAe,GAAG,OAAO,CAAC,GAAG,CAAC,wBAA2D,CAAA;IAC/F,IAAI;QACF,MAAM,CAAC,eAAe,CAAC,CAAC,CAAC,wBAAwB,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,mBAAmB,EAAE,CAAC,CAAA;KAC5F;IAAC,OAAO,GAAG,EAAE;QACZ,UAAU,CAAC,iBAAiB,CAAC,CAAA;QAC7B,MAAM,GAAG,CAAA;KACV;IACD,OAAO,aAAa,CAAA;AACtB,CAAC;AAED,KAAK,UAAU,wBAAwB,CAAC,eAAoC;IAC1E,UAAU,CACR,aAAa,CAAA,6DAA6D,WAAW,CAAC,mBAAmB,CACvG,cAAc,CACf,KAAK,CACP,CAAA;IACD,MAAM,IAAI,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,EAAE,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAA;IAClD,MAAM,IAAI,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,eAAe,CAAC,EAAE,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAA;AACtE,CAAC;AAED,KAAK,UAAU,mBAAmB;IAChC,MAAM,OAAO,GAAG,KAAK,CAAA;IACrB,MAAM,IAAI,GAAG;QACX,SAAS;QACT,IAAI;QACJ,GAAG,MAAM,aAAa,EAAE,SAAS;QACjC,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,GAAG,MAAM,SAAS,CAAC;KACrD,CAAA;IACD,UAAU,CACR,aAAa,CAAA,6BAA6B,WAAW,CAAC,mBAAmB,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,KAAK,CAC7G,CAAA;IACD,MAAM,IAAI,CAAC,OAAO,EAAE,IAAI,EAAE,EAAC,KAAK,EAAE,SAAS,EAAC,CAAC,CAAA;AAC/C,CAAC;AAED,SAAS,wBAAwB,CAAC,cAAsB;IACtD,UAAU,CAAC,aAAa,CAAA,iCAAiC,WAAW,CAAC,MAAM,CAAC,cAAc,CAAC,uBAAuB,CAAC,CAAA;AACrH,CAAC;AAED,SAAS,oBAAoB,CAAC,cAAsB,EAAE,aAAqB;IACzE,UAAU,CACR,aAAa,CAAA,sBAAsB,WAAW,CAAC,MAAM,CAAC,cAAc,CAAC,OAAO,WAAW,CAAC,MAAM,CAAC,aAAa,CAAC,KAAK,CACnH,CAAA;AACH,CAAC;AAED,KAAK,UAAU,uBAAuB,CACpC,OAAuB,EACvB,IAA6B,EAC7B,SAAiB;IAEjB,MAAM,gBAAgB,GAAG,CAAC,MAAM,aAAa,EAAE,EAAE,GAAG,CAAC,MAAM,YAAY,EAAE,CAAC,CAAC;SACxE,MAAM,CAAC,CAAC,GAAW,EAAW,EAAE;QAC/B,MAAM,cAAc,GAAuB,IAAI,CAAC,GAAG,CAAC,CAAA;QACpD,OAAO,OAAO,CAAC,cAAc,CAAC,CAAA;IAChC,CAAC,CAAC;SACD,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE;QACX,OAAO,EAAC,IAAI,EAAE,GAAG,EAAE,OAAO,EAAE,QAAQ,EAAC,CAAA;IACvC,CAAC,CAAC,CAAA;IAEJ,IAAI,gBAAgB,CAAC,MAAM,GAAG,CAAC,EAAE;QAC/B,MAAM,kBAAkB,CAAC,gBAAgB,EAAE;YACzC,cAAc,EAAE,MAAM,iBAAiB,CAAC,SAAS,CAAC;YAClD,IAAI,EAAE,OAAO;YACb,SAAS;YACT,MAAM,EAAE,OAAO,CAAC,MAAM;YACtB,MAAM,EAAE,OAAO,CAAC,MAAM;SACvB,CAAC,CAAA;KACH;AACH,CAAC;AAED,KAAK,UAAU,aAAa;IAC1B,OAAO,CAAC,MAAM,mBAAmB,EAAE,CAAC,CAAC,IAAI,CAAA;AAC3C,CAAC;AAED,KAAK,UAAU,YAAY;IACzB,OAAO,CAAC,MAAM,mBAAmB,EAAE,CAAC,EAAE,KAAK,EAAE,OAAO,IAAI,EAAE,CAAA;AAC5D,CAAC;AAGD,IAAI,oBAAqD,CAAA;AAEzD,KAAK,UAAU,mBAAmB;IAChC,IAAI,CAAC,oBAAoB,EAAE;QACzB,MAAM,WAAW,GAAG,MAAM,wBAAwB,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAA;QACpF,oBAAoB,GAAG,oBAAoB,IAAK,WAAW,CAAC,OAA+B,CAAA;KAC5F;IACD,OAAO,oBAAoB,CAAA;AAC7B,CAAC;AAED,SAAS,mBAAmB;IAC1B,OAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAA;AACnD,CAAC","sourcesContent":["import {\n  addNPMDependencies,\n  findUpAndReadPackageJson,\n  checkForNewVersion,\n  DependencyType,\n  getPackageManager,\n  PackageJson,\n} from '@shopify/cli-kit/node/node-package-manager'\nimport {exec} from '@shopify/cli-kit/node/system'\nimport {dirname, moduleDirectory} from '@shopify/cli-kit/node/path'\nimport {findPathUp} from '@shopify/cli-kit/node/fs'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {outputContent, outputInfo, outputSuccess, outputToken, outputWarn} from '@shopify/cli-kit/node/output'\n\ntype HomebrewPackageName = 'shopify-cli' | 'shopify-cli@3'\n\n// Canonical list of oclif plugins that should be installed globally\nconst globalPlugins = ['@shopify/theme']\n\nexport async function upgrade(directory: string, currentVersion: string): Promise<void> {\n  let newestVersion: string | void\n\n  const projectDir = await getProjectDir(directory)\n  if (projectDir) {\n    newestVersion = await upgradeLocalShopify(projectDir, currentVersion)\n  } else if (usingPackageManager()) {\n    throw new AbortError(\n      outputContent`Couldn't find the configuration file for ${outputToken.path(\n        directory,\n      )}, are you in a Shopify project directory?`,\n    )\n  } else {\n    newestVersion = await upgradeGlobalShopify(currentVersion)\n  }\n\n  if (newestVersion) {\n    outputSuccess(`Upgraded Shopify CLI to version ${newestVersion}`)\n  }\n}\n\nasync function getProjectDir(directory: string): Promise<string | undefined> {\n  const configFile = await findPathUp(['shopify.app.toml', 'hydrogen.config.js', 'hydrogen.config.ts'], {\n    cwd: directory,\n    type: 'file',\n  })\n  if (configFile) return dirname(configFile)\n}\n\nasync function upgradeLocalShopify(projectDir: string, currentVersion: string): Promise<string | void> {\n  const packageJson = (await findUpAndReadPackageJson(projectDir)).content\n  const packageJsonDependencies = packageJson.dependencies || {}\n  const packageJsonDevDependencies = packageJson.devDependencies || {}\n\n  let resolvedVersion: string = {...packageJsonDependencies, ...packageJsonDevDependencies}[await cliDependency()]!\n  if (resolvedVersion.slice(0, 1).match(/[\\^~]/)) resolvedVersion = currentVersion\n  const newestVersion = await checkForNewVersion(await cliDependency(), resolvedVersion)\n\n  if (!newestVersion) {\n    outputWontInstallMessage(resolvedVersion)\n    return\n  }\n\n  outputUpgradeMessage(resolvedVersion, newestVersion)\n\n  await installJsonDependencies('prod', packageJsonDependencies, projectDir)\n  await installJsonDependencies('dev', packageJsonDevDependencies, projectDir)\n  return newestVersion\n}\n\nasync function upgradeGlobalShopify(currentVersion: string): Promise<string | void> {\n  const newestVersion = await checkForNewVersion(await cliDependency(), currentVersion)\n\n  if (!newestVersion) {\n    outputWontInstallMessage(currentVersion)\n    return\n  }\n\n  outputUpgradeMessage(currentVersion, newestVersion)\n\n  const homebrewPackage = process.env.SHOPIFY_HOMEBREW_FORMULA as HomebrewPackageName | undefined\n  try {\n    await (homebrewPackage ? upgradeGlobalViaHomebrew(homebrewPackage) : upgradeGlobalViaNpm())\n  } catch (err) {\n    outputWarn('Upgrade failed!')\n    throw err\n  }\n  return newestVersion\n}\n\nasync function upgradeGlobalViaHomebrew(homebrewPackage: HomebrewPackageName): Promise<void> {\n  outputInfo(\n    outputContent`Homebrew installation detected. Attempting to upgrade via ${outputToken.genericShellCommand(\n      'brew upgrade',\n    )}...`,\n  )\n  await exec('brew', ['update'], {stdio: 'inherit'})\n  await exec('brew', ['upgrade', homebrewPackage], {stdio: 'inherit'})\n}\n\nasync function upgradeGlobalViaNpm(): Promise<void> {\n  const command = 'npm'\n  const args = [\n    'install',\n    '-g',\n    `${await cliDependency()}@latest`,\n    ...globalPlugins.map((plugin) => `${plugin}@latest`),\n  ]\n  outputInfo(\n    outputContent`Attempting to upgrade via ${outputToken.genericShellCommand([command, ...args].join(' '))}...`,\n  )\n  await exec(command, args, {stdio: 'inherit'})\n}\n\nfunction outputWontInstallMessage(currentVersion: string): void {\n  outputInfo(outputContent`You're on the latest version, ${outputToken.yellow(currentVersion)}, no need to upgrade!`)\n}\n\nfunction outputUpgradeMessage(currentVersion: string, newestVersion: string): void {\n  outputInfo(\n    outputContent`Upgrading CLI from ${outputToken.yellow(currentVersion)} to ${outputToken.yellow(newestVersion)}...`,\n  )\n}\n\nasync function installJsonDependencies(\n  depsEnv: DependencyType,\n  deps: {[key: string]: string},\n  directory: string,\n): Promise<void> {\n  const packagesToUpdate = [await cliDependency(), ...(await oclifPlugins())]\n    .filter((pkg: string): boolean => {\n      const pkgRequirement: string | undefined = deps[pkg]\n      return Boolean(pkgRequirement)\n    })\n    .map((pkg) => {\n      return {name: pkg, version: 'latest'}\n    })\n\n  if (packagesToUpdate.length > 0) {\n    await addNPMDependencies(packagesToUpdate, {\n      packageManager: await getPackageManager(directory),\n      type: depsEnv,\n      directory,\n      stdout: process.stdout,\n      stderr: process.stderr,\n    })\n  }\n}\n\nasync function cliDependency(): Promise<string> {\n  return (await packageJsonContents()).name\n}\n\nasync function oclifPlugins(): Promise<string[]> {\n  return (await packageJsonContents())?.oclif?.plugins || []\n}\n\ntype PackageJsonWithName = Omit<PackageJson, 'name'> & {name: string}\nlet _packageJsonContents: PackageJsonWithName | undefined\n\nasync function packageJsonContents(): Promise<PackageJsonWithName> {\n  if (!_packageJsonContents) {\n    const packageJson = await findUpAndReadPackageJson(moduleDirectory(import.meta.url))\n    _packageJsonContents = _packageJsonContents || (packageJson.content as PackageJsonWithName)\n  }\n  return _packageJsonContents\n}\n\nfunction usingPackageManager(): boolean {\n  return Boolean(process.env.npm_config_user_agent)\n}\n"]}